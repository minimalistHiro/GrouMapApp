# GrouMapアプリ 要件仕様書

## 1. プロジェクト概要

### 1.1 アプリ概要
- **アプリ名**: GrouMap
- **プラットフォーム**: iOS/Android対応のモバイルアプリケーション
- **技術スタック**: Flutter + Firebase
- **アプリ種別**: ユーザーアプリと店舗用アプリの2種類

### 1.2 目的
地図を活用した店舗発見・ポイントシステム・クーポン機能を核とするプラットフォームアプリの提供

## 2. 機能要件

### 2.1 共通機能
- **認証機能**: Firebase Auth を使用したユーザー認証
- **地図連携**: Google Maps Platform を使用したリアルタイム地図表示
  - カスタムピン機能（店舗ピンのデザインカスタマイズ）
  - ピンタップ時のインタラクション（サイズ変更、アニメーション）
  - 多層ピンアイコン（影・枠・画像の組み合わせ）
  - カスタム情報ウィンドウ表示
- **権限管理**: 一般ユーザー・店舗オーナー・会社管理者の多階層権限システム
- **画像処理**: Firebase Storage + 圧縮処理機能
- **プッシュ通知**: Firebase Cloud Messaging (FCM) によるリアルタイム通知

### 2.2 ユーザーアプリ機能
- **店舗検索・発見**: 地図上での店舗表示・検索機能
  - カスタムピンによる視覚的な店舗識別
  - ピンタップ時の詳細情報表示（2倍サイズ化等）
  - 飲食店カテゴリ別のピンデザイン
    - レストラン、カフェ、居酒屋、ファストフード、ラーメン、寿司、焼肉、スイーツ、パン屋、バー等
- **ポイント・スタンプ機能**: 来店時のポイント獲得・スタンプ収集
- **セキュアQRコード機能**: 
  - JWT（JSON Web Token）ベースの時間制限付きQRコード
  - 60秒ごとに自動更新される動的QRコード表示
  - UID + 時間窓による署名検証
  - ポイント獲得用QRコード表示（店舗スタッフが読み取り）
  - ポイント利用時の店頭QRコード読み取り機能
  - 重複使用防止・リプレイアタック対策
- **レベルシステム**: ユーザーレベル（1~100Lv）の表示・進行管理
  - 経験値獲得条件：ポイント獲得・ポイント利用・バッジ獲得
  - レベル上昇に伴う必要経験値の増加システム
- **バッジシステム**: 特定条件達成時のバッジ獲得機能
- **クーポン機能**: 店舗からのクーポン受信・利用
- **プロフィール管理**: ユーザー情報の管理
- **お気に入り店舗**: 店舗のお気に入り登録・管理

### 2.3 店舗用アプリ機能

#### 2.3.1 基本店舗機能
- **店舗情報管理**: 店舗基本情報・営業時間・画像等の管理
- **QRコード機能**:
  - ユーザーのQRコード読み取りによるポイント付与
  - 店頭QRコード生成・管理（ユーザーのポイント利用用）
- **クーポン配信**: ユーザーへのクーポン作成・配信機能
- **ポイント管理**: 来店ユーザーへのポイント付与管理
- **顧客分析**: 来店データ・ユーザー行動の分析機能
- **プラン管理**: 小規模・標準・プレミアム追加プランによる機能制限

#### 2.3.2 会社管理者限定機能
- **複数店舗管理**: 会社配下の全店舗データの一括管理
- **統合レポート**: 会社全体の売上・来店データの分析
- **店舗オーナー管理**: 配下店舗の権限管理・アカウント管理
- **会社設定管理**: 会社レベルのポリシー・設定管理
- **統合ダッシュボード**: 会社全体のKPI表示・管理画面

## 3. 技術要件

### 3.1 フロントエンド
- **フレームワーク**: Flutter (Dart SDK ^3.5.0)
- **状態管理**: Riverpod
- **コードスタイル**: flutter_lints ^4.0.0

### 3.2 バックエンド
- **Firebase Auth**: 認証システム
- **Firestore**: データベース
- **Firebase Functions**: サーバーサイド処理
- **Firebase Storage**: 画像・ファイルストレージ
- **Firebase Cloud Messaging**: プッシュ通知

### 3.3 外部サービス
- **Google Maps Platform**: 地図機能
- **タイムゾーン**: Asia/Tokyo 固定

## 4. データ要件

### 4.1 ユーザーデータ
- 基本プロフィール情報
- 認証情報
- レベル情報（1~100Lv）
- 経験値・レベル進行データ
- 獲得バッジリスト・バッジ進捗データ
- ポイント・スタンプ履歴
- お気に入り店舗リスト

### 4.2 店舗データ
- 店舗基本情報（名前、住所、営業時間等）
- 位置情報（緯度経度）
- 店舗画像
- クーポン情報
- プラン情報（小規模・標準・プレミアム追加）
- 権限情報（`isCompanyAdmin` フラグ）
- 会社情報（会社管理者の場合の配下店舗情報）

### 4.3 取引データ
- ポイント付与・利用履歴
- QRコード読み取り履歴・取引データ
- クーポン利用履歴
- 来店履歴
- レベルアップ・経験値獲得履歴
- バッジ獲得履歴・進捗データ
- プラン利用状況・課金データ
- 月次ポイント発行量・超過料金データ
- 手数料計算データ

## 5. UI・画面構成要件

### 5.1 デザインシステム
- **ブランドカラー**: #E75B41（メインカラー）
- **カラーパレット**: メインカラーを基調とした統一感のあるデザイン
- **アプリアイコン**:
  - ユーザー用アプリ: `/Users/kanekohiroki/Desktop/groumapapp/assets/images/groumap_icon.png`
  - 店舗用アプリ: `/Users/kanekohiroki/Desktop/groumapapp/assets/images/groumap_store_icon.png`

### 5.2 ボトムナビゲーション構成
- **4つのタブ構成**: 左から「ホーム」「マップ」「投稿」「アカウント」
- **中央QRボタン**: 円形フローティングアクションボタンでQRコード機能
- **レスポンシブ設計**: iOS/Android両対応のネイティブ感のあるUI

### 5.3 各画面の主要機能
- **ホーム画面**: ダッシュボード・お知らせ・レベル表示等
- **マップ画面**: Google Maps・店舗検索・カスタムピン表示
- **投稿画面**: レビュー投稿・写真投稿等（プレミアム機能）
- **アカウント画面**: プロフィール・設定・獲得バッジ・レベル詳細
- **QRコード**: 店舗でのポイント獲得・利用機能
  - ポイント獲得：店舗スタッフがユーザーのQRコードを読み取り
  - ポイント利用：ユーザーが店頭のQRコードを読み取り

## 6. 非機能要件

### 6.1 パフォーマンス
- 地図表示の高速化
- 画像の適切な圧縮・最適化
- リアルタイムデータ同期

### 6.2 セキュリティ
- Firebase Security Rules による適切なデータアクセス制御
- 権限レベルに応じたアクセス制限
- 画像アップロード時のセキュリティ対策

### 6.3 可用性
- オフライン時の基本機能利用
- エラーハンドリングの適切な実装

## 7. 制約事項

### 7.1 権限管理
- **会社管理者制御**: データベース上の `isCompanyAdmin` フラグによる会社管理者機能のON/OFF制御
  - 店舗用アプリ内で会社管理者機能の表示・非表示切り替え
  - フラグがONの場合のみ会社管理機能へのアクセス許可
  - リアルタイムでの権限変更反映
- **プラン制限**: 小規模・標準・プレミアム追加プランによる機能制限の実装必須

### 7.2 開発制約
- Firebaseプロジェクト名: groumapapp
- Flutter推奨のコードスタイルに従う
- flutter_lints ^4.0.0 によるコード品質管理

## 8. ゲーミフィケーション設計

### 8.1 レベルシステム詳細

#### 8.1.1 レベル仕様
- **レベル範囲**: 1~100レベル
- **レベルアップ仕様**: レベルが上がるにつれて必要経験値が増加
- **計算式例**: 必要経験値 = ベース経験値 × (レベル ^ 1.5) ※設計時に詳細決定

#### 8.1.2 経験値獲得条件
1. **ポイント獲得**: 1ポイント獲得 = X経験値
2. **ポイント利用**: 1ポイント利用 = Y経験値  
3. **バッジ獲得**: バッジ種別により経験値付与量変動

#### 8.1.3 バッジシステム
- **初回来店バッジ**: 初回店舗来店時
- **連続来店バッジ**: 連続来店日数達成時
- **ポイント達成バッジ**: 累計ポイント獲得量達成時
- **店舗制覇バッジ**: 特定エリアの店舗巡り完了時
- **その他**: レビュー投稿、友達招待等

## 9. 料金プラン・収益構造

### 9.1 店舗用アプリの料金プラン

#### 9.1.1 小規模プラン
- **月額料金**: 2,980円/月
- **ポイント発行上限**: 1,500P/月
- **超過料金**: 1P = 1.1円（原資1円 + 10%手数料）
- **利用時手数料**: 1%
- **利用可能機能**: ポイント発行のみ

#### 9.1.2 標準プラン
- **月額料金**: 4,980円/月
- **ポイント発行上限**: 5,000P/月
- **超過料金**: 1P = 1.1円（原資1円 + 10%手数料）
- **利用時手数料**: 1%
- **利用可能機能**: ポイント発行のみ

#### 9.1.3 プレミアム追加オプション
- **追加料金**: +4,000円/月（小規模または標準プランに追加）
- **解放機能**: 投稿機能・クーポン機能
- **適用**: 小規模プラン + プレミアム = 6,980円/月、標準プラン + プレミアム = 8,980円/月

### 9.2 収益構造
1. **加盟料（サブスクリプション）**: 月額基本料金
2. **超過課金**: ポイント上限超過時の従量課金（1.1円/pt）
3. **利用時手数料**: ポイント利用時の手数料（1%）

## 10. 開発・運用要件

### 10.1 開発コマンド
- 依存関係インストール: `flutter pub get`
- アプリ実行: `flutter run`
- コード解析: `flutter analyze`
- テスト実行: `flutter test`
- ビルド: `flutter build apk` / `flutter build ios`

### 10.2 プロジェクト構成
```
lib/
├── main.dart                    # エントリポイント
├── core/                        # 共通コア機能
├── models/                      # データモデル
├── repositories/                # データアクセス層
├── services/                    # サービス層
├── providers/                   # Riverpod状態管理
├── views/                       # UI画面
└── widgets/                     # 再利用可能ウィジェット
```