rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isOwner() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isOwner == true;
    }
    function isStoreOwner(storeId) {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isStoreOwner == true &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.currentStoreId == storeId ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.createdStores.hasAny([storeId]));
    }
    function isStoreMember(storeId) {
      return request.auth != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.currentStoreId == storeId ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.createdStores.hasAny([storeId]));
    }
    function canManageStoreCoupons(storeId) {
      return isOwner() ||
        (
          request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isStoreOwner == true &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.createdStores.hasAny([storeId])
        );
    }
    function isStoreStaff() {
      return request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.currentStoreId != null;
    }
    function serviceChatRoom(roomId) {
      return get(/databases/$(database)/documents/service_chat_rooms/$(roomId));
    }
    function isServiceChatUser(roomId) {
      return request.auth != null && serviceChatRoom(roomId).data.userId == request.auth.uid;
    }
    function isServiceChatOwner() {
      return request.auth != null && isOwner();
    }
    function isCouponUserViewIncrement() {
      return request.auth != null
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['viewCount','updatedAt'])
        && request.resource.data.viewCount == resource.data.viewCount + 1;
    }
    function isCouponUserUseIncrement() {
      return request.auth != null
        && !(resource.data.isActive == false)
        && (resource.data.usageLimit is int || resource.data.usageLimit is float)
        && (resource.data.usedCount is int || resource.data.usedCount is float)
        && resource.data.usageLimit > 0
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['usedCount','isActive','updatedAt'])
        && request.resource.data.usedCount == resource.data.usedCount + 1
        && request.resource.data.usedCount <= resource.data.usageLimit
        && (
          (request.resource.data.usedCount < resource.data.usageLimit
            && request.resource.data.isActive == resource.data.isActive) ||
          (request.resource.data.usedCount == resource.data.usageLimit
            && request.resource.data.isActive == false)
        );
    }
    function isCouponUserUseIncrementLegacy() {
      return request.auth != null
        && !(resource.data.isActive == false)
        && !(resource.data.usedCount is int || resource.data.usedCount is float)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['usedCount','isActive','updatedAt'])
        && (request.resource.data.usedCount is int || request.resource.data.usedCount is float)
        && request.resource.data.usedCount >= 1
        && request.resource.data.isActive is bool
        && (
          (request.resource.data.usageLimit is int || request.resource.data.usageLimit is float)
            ? request.resource.data.usedCount <= request.resource.data.usageLimit
            : true
        );
    }
    // ユーザーコレクションのルール
    match /users/{userId} {
      // 認証されたユーザーは自分のドキュメントを読み書き可能
      allow read: if request.auth != null && (request.auth.uid == userId || isOwner() || isStoreStaff());
      allow write: if request.auth != null && request.auth.uid == userId;
      // 店舗側のポイント利用による更新を許可
      allow update: if request.auth != null
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['points','specialPoints','lastUpdated','lastUpdatedByStoreId'])
        && request.resource.data.lastUpdatedByStoreId is string
        && isStoreMember(request.resource.data.lastUpdatedByStoreId);
      // 新規ユーザー作成時は認証されたユーザーのみ
      allow create: if request.auth != null && request.auth.uid == userId;

      // ユーザーの店舗スタンプ（users/{userId}/stores/{storeId}）
      match /stores/{storeId} {
        allow read, write: if request.auth != null &&
          (request.auth.uid == userId || isOwner() || isStoreMember(storeId));
      }

      // ユーザーの使用済みクーポン（users/{userId}/used_coupons/{couponId}）
      match /used_coupons/{couponId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // ユーザーのいいね履歴（users/{userId}/liked_posts/{postId}）
      match /liked_posts/{postId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ユーザーのお気に入り店舗（users/{userId}/favorite_stores/{storeId}）
      match /favorite_stores/{storeId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ユーザーのコメント履歴（users/{userId}/comments/{commentId}）
      match /comments/{commentId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ユーザー通知（users/{userId}/notifications/{notificationId}）
      match /notifications/{notificationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // マップフィルター設定（users/{userId}/map_filter/{docId}）
      match /map_filter/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // デイリーミッション（users/{userId}/daily_missions/{date}）
      match /daily_missions/{date} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 投稿コレクションのルール
    match /posts/{postId} {
      // 公開閲覧可
      allow read: if true;
      // 管理者のみ書き込み可能（必要に応じて調整）
      allow write: if request.auth != null;

      // コメント（posts/{postId}/comments/{commentId}）
      match /comments/{commentId} {
        allow read: if true;
        allow write: if request.auth != null;
      }

      // いいね（posts/{postId}/likes/{likeId}）
      match /likes/{likeId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    // 公開投稿コレクション（ユーザー表示用）
    match /public_posts/{postId} {
      allow read: if true;
      allow create: if isOwner() || isStoreOwner(request.resource.data.storeId);
      allow update: if request.auth != null;
      allow delete: if isOwner() || isStoreOwner(resource.data.storeId);

      match /comments/{commentId} {
        allow read: if true;
        allow write: if request.auth != null;
      }

      match /likes/{likeId} {
        allow read: if true;
        allow write: if request.auth != null;
      }

      match /views/{userId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if false;
      }
    }
    
    // クーポンコレクションのルール（トップレベル）
    match /coupons/{couponId} {
      // 公開閲覧可
      allow read: if true;
      // オーナー/店舗オーナーのみ作成・更新・削除可能
      allow create: if canManageStoreCoupons(request.resource.data.storeId);
      allow update, delete: if canManageStoreCoupons(resource.data.storeId);

      // クーポン使用履歴: coupons/{couponId}/usedBy/{userId}
      match /usedBy/{userId} {
        // 認証されたユーザーは読み取り可能
        allow read: if request.auth != null;
        // 認証されたユーザーは自分の使用履歴を作成可能
        allow create: if request.auth != null && request.auth.uid == userId;
        // 更新・削除は禁止
        allow update, delete: if false;
      }
    }

    // 店舗配下のクーポン（coupons/{storeId}/coupons/{couponId}）
    match /coupons/{storeId}/coupons/{couponId} {
      // 公開閲覧可
      allow read: if true;
      // オーナー/店舗オーナーのみ作成・更新・削除可能
      allow create: if canManageStoreCoupons(storeId);
      allow update: if canManageStoreCoupons(storeId)
        || isCouponUserViewIncrement()
        || isCouponUserUseIncrement()
        || isCouponUserUseIncrementLegacy();
      allow delete: if canManageStoreCoupons(storeId);

      // クーポン使用履歴: coupons/{storeId}/coupons/{couponId}/usedBy/{userId}
      match /usedBy/{userId} {
        // 認証されたユーザーは読み取り可能
        allow read: if request.auth != null;
        // 認証されたユーザーは自分の使用履歴を作成可能
        allow create: if request.auth != null && request.auth.uid == userId;
        // 更新・削除は禁止
        allow update, delete: if false;
      }
    }

    // ユーザークーポン（トップレベル）
    match /user_coupons/{userCouponId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // 未ログインの取得を許可（guest）
      allow create: if (request.auth != null && request.resource.data.userId == request.auth.uid)
        || (request.auth == null && request.resource.data.userId == 'guest');
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // 通知コレクションのルール
    match /notifications/{notificationId} {
      // 認証されたユーザーは読み取り可能
      allow read: if request.auth != null;
      // 管理者のみ書き込み可能（必要に応じて調整）
      allow write: if request.auth != null;
    }

    // サービス全体ライブチャット
    match /service_chat_rooms/{roomId} {
      allow read: if request.auth != null &&
        (resource.data.userId == request.auth.uid || isServiceChatOwner());
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null &&
        (
          (
            isServiceChatUser(roomId) &&
            request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(['userLastReadAt','userUnreadCount','updatedAt']) &&
            request.resource.data.userUnreadCount == 0
          ) ||
          (
            isServiceChatOwner() &&
            request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(['ownerLastReadAt','ownerUnreadCount','updatedAt']) &&
            request.resource.data.ownerUnreadCount == 0
          )
        );
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if request.auth != null &&
          (serviceChatRoom(roomId).data.userId == request.auth.uid ||
           isServiceChatOwner());
        allow create: if request.auth != null &&
          exists(/databases/$(database)/documents/service_chat_rooms/$(roomId)) &&
          (
            (
              request.resource.data.senderRole == 'user' &&
              request.resource.data.senderId == request.auth.uid &&
              request.auth.uid == serviceChatRoom(roomId).data.userId
            ) ||
            (
              request.resource.data.senderRole == 'owner' &&
              request.resource.data.senderId == request.auth.uid &&
              isServiceChatOwner()
            )
          );
        allow update: if request.auth != null &&
          (
            (
              serviceChatRoom(roomId).data.userId == request.auth.uid &&
              request.resource.data.diff(resource.data).changedKeys()
                .hasOnly(['readByUserAt']) &&
              request.resource.data.readByUserAt is timestamp
            ) ||
            (
              isServiceChatOwner() &&
              request.resource.data.diff(resource.data).changedKeys()
                .hasOnly(['readByOwnerAt']) &&
              request.resource.data.readByOwnerAt is timestamp
            )
          );
        allow delete: if false;
      }
    }
    
    // ランキングコレクションのルール
    match /rankings/{rankingId} {
      // 認証されたユーザーは読み取り可能
      allow read: if request.auth != null;
      // 管理者のみ書き込み可能（必要に応じて調整）
      allow write: if request.auth != null;
    }
    
    // スロット履歴コレクションのルール
    match /slot_history/{slotId} {
      // 認証されたユーザーは自分のスロット履歴のみ読み書き可能
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      // 新規作成時は認証されたユーザーのみ
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // くじ引き（スロット）履歴コレクションのルール
    match /lottery_history/{lotteryId} {
      // 認証されたユーザーは自分のくじ引き履歴のみ読み書き可能
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      // 新規作成時は認証されたユーザーのみ
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // QR JTIコレクションのルール（リプレイ防止用）
    match /qrJti/{jti} {
      // サーバーサイド（Firebase Functions）からのみ書き込み可能
      // クライアントからの直接アクセスは禁止
      allow read, write: if false;
    }
    
    // チェックインコレクションのルール
    match /check_ins/{checkInId} {
      // 認証されたユーザーは自分のチェックイン履歴のみ読み取り可能
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // 書き込みはサーバーサイドのみ
      allow write: if false;
    }
    
    // バッジマスタ（アプリ内蔵に移行済み。既存データ参照用にreadのみ残す）
    match /badges/{badgeId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ユーザーの獲得バッジ（階層: user_badges/{userId}/badges/{badgeId}）
    match /user_badges/{userId}/badges/{badgeId} {
      allow read: if request.auth != null && request.auth.uid == userId;

      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['userId','badgeId','unlockedAt','isNew'])
        && request.resource.data.userId == userId
        && request.resource.data.badgeId == badgeId
        && request.resource.data.unlockedAt is timestamp
        && request.resource.data.isNew is bool
        && (!('progress' in request.resource.data) || request.resource.data.progress is int)
        && (!('requiredValue' in request.resource.data) || request.resource.data.requiredValue is int);

      // isNew のみ更新可
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.badgeId == resource.data.badgeId
        && request.resource.data.requiredValue == resource.data.requiredValue
        && request.resource.data.progress == resource.data.progress
        && request.resource.data.unlockedAt == resource.data.unlockedAt
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['isNew'])
        && request.resource.data.isNew is bool;

      // 自分のバッジは削除可（ロックへ戻す用途）
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // ユーザー実績イベント（スタンプ押印後のバッジ・レコメンド表示用）
    match /user_achievement_events/{userId}/events/{eventId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // seenAt / coinBonusAwarded のみ更新可
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['seenAt', 'coinBonusAwarded'])
        && (
          !request.resource.data.diff(resource.data).changedKeys().hasAny(['seenAt'])
          || request.resource.data.seenAt is timestamp
        )
        && (
          !request.resource.data.diff(resource.data).changedKeys().hasAny(['coinBonusAwarded'])
          || request.resource.data.coinBonusAwarded is bool
        );
    }

    // バッジ進捗
    match /badge_progress/{docId} {
      // 自分の進捗のみ閲覧可
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // 自分の進捗のみ作成/更新可（基本的な型チェック）
      allow create, update: if request.auth != null
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId','badgeType','currentValue'])
        && request.resource.data.userId is string
        && request.resource.data.badgeType is string
        && request.resource.data.currentValue is int;

      allow delete: if false;
    }

    // ポイント取引コレクションのルール
    match /point_transactions/{transactionId} {
      // 認証されたユーザーは自分のポイント取引履歴のみ読み取り可能
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // 書き込みはサーバーサイドのみ
      allow write: if false;
    }

    // ポイント取引（ネスト構造）
    match /point_transactions/{storeId}/{userId}/{transactionId} {
      allow read: if request.auth != null
        && (request.auth.uid == userId || isStoreOwner(storeId));
      allow create: if request.auth != null && (request.auth.uid == userId || isStoreMember(storeId));
      allow update, delete: if false;
    }

    // ポイント付与リクエスト
    match /point_requests/{storeId} {
      allow read: if request.auth != null;

      match /{userId}/{requestId} {
        allow read: if request.auth != null
          && (request.auth.uid == userId || isStoreOwner(storeId));
        allow create: if isStoreOwner(storeId);
        allow update: if request.auth != null
          && (request.auth.uid == userId || isStoreOwner(storeId));
        allow delete: if false;
      }
    }

    // QRコード（ポイント付与用）
    match /qr_codes/{qrCodeId} {
      allow read: if request.auth != null
        && (request.auth.uid == resource.data.userId || isStoreOwner(resource.data.storeId));
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null
        && (request.auth.uid == resource.data.userId || isStoreOwner(resource.data.storeId));
      allow delete: if false;
    }
    
    // 店舗コレクションのルール
    match /stores/{storeId} {
      // 公開閲覧可
      allow read: if true;
      // 新規作成は未ログインユーザーも許可
      allow create: if true;
      // 更新はオーナー or 店舗メンバーのみ可能
      allow update: if isOwner() || isStoreMember(storeId);
      // 削除はオーナー、または作成者本人のみ可能
      allow delete: if isOwner() || (request.auth != null && request.auth.uid == resource.data.createdBy);

      // 店舗取引履歴
      match /transactions/{transactionId} {
        allow read: if request.auth != null && isStoreMember(storeId);
        allow create: if request.auth != null && isStoreMember(storeId);
        allow update, delete: if false;
      }

      // 店舗のお気に入りユーザー
      match /favorite_users/{userId} {
        allow read: if request.auth != null;
        allow create, delete: if request.auth != null && request.auth.uid == userId;
        allow update: if false;
      }

      // メニュー
      match /menu/{menuId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null && (isOwner() || isStoreMember(storeId));
      }

      // 店内画像
      match /interior_images/{imageId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null && (isOwner() || isStoreMember(storeId));
      }

      // 店舗ごとのInstagram投稿（ユーザー表示用）
      match /instagram_posts/{instagramPostId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null && (isOwner() || isStoreMember(storeId));
      }
    }

    // ユーザーのポイント残高
    match /user_point_balances/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isOwner() || isStoreStaff());
      allow create, update: if request.auth != null
        && request.resource.data.lastUpdatedByStoreId is string
        && isStoreMember(request.resource.data.lastUpdatedByStoreId);
      allow delete: if false;
    }

    // 店舗統計（日次）
    match /store_stats/{storeId}/daily/{dateId} {
      allow read: if request.auth != null && isStoreMember(storeId);
      allow create, update: if request.auth != null && isStoreMember(storeId);
      allow delete: if false;
    }

    // 店舗来店ユーザー集計
    match /store_users/{storeId}/users/{userId} {
      allow read, write: if request.auth != null && (isOwner() || isStoreMember(storeId));
    }
    
    // お知らせコレクションのルール
    match /announcements/{announcementId} {
      // 公開閲覧可
      allow read: if true;
      // オーナーのみ作成・更新・削除可能
      allow create, update, delete: if isOwner();
    }

    // ニュースコレクションのルール
    match /news/{newsId} {
      // 公開閲覧可
      allow read: if true;
      // オーナーのみ作成・更新・削除可能
      allow create, update, delete: if isOwner();
    }

    // オーナー設定コレクション
    match /owner_settings/{storeId} {
      allow read: if true;
      allow create, update, delete: if isOwner();
    }

    // プロモーション（クーポン画面表示用）
    match /promotions/{promotionId} {
      allow read: if true;
      allow write: if isOwner();
    }

    // 公開クーポン（ユーザー表示用）
    match /public_coupons/{couponId} {
      allow read: if true;
      allow create: if canManageStoreCoupons(request.resource.data.storeId);
      allow update: if canManageStoreCoupons(resource.data.storeId)
        || isCouponUserViewIncrement()
        || isCouponUserUseIncrement()
        || isCouponUserUseIncrementLegacy();
      allow delete: if canManageStoreCoupons(resource.data.storeId);
    }

    // 公開Instagram投稿（ユーザー表示用）
    match /public_instagram_posts/{instagramPostId} {
      allow read: if true;
      allow create: if isOwner() || isStoreOwner(request.resource.data.storeId);
      allow update: if request.auth != null;
      allow delete: if isOwner() || isStoreOwner(resource.data.storeId);

      match /comments/{commentId} {
        allow read: if true;
        allow write: if request.auth != null;
      }

      match /likes/{likeId} {
        allow read: if true;
        allow write: if request.auth != null;
      }

      match /views/{userId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if false;
      }
    }
    
    // レコメンデーション表示記録
    match /recommendation_impressions/{impressionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // レコメンデーションクリック記録
    match /recommendation_clicks/{clickId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ログイン日次統計（daily_login_stats/{dateKey}）
    match /daily_login_stats/{dateKey} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly(['loginCount', 'date'])
        && request.resource.data.loginCount is int
        && request.resource.data.date is string;
      allow update: if request.auth != null;
      allow delete: if false;
    }

    // その他のコレクションは認証されたユーザーのみ読み取り可能
    match /{document=**} {
      allow read: if request.auth != null;
    }
  }
}
