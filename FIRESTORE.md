# FIRESTORE.md

## Firestore: コレクション一覧（abc順・コード参照ベース）

### badges（廃止・アプリ内蔵に移行済み）
- `badges/{badgeId}`: バッジ定義（参照専用・write無効）
  - バッジ定義はアプリ内蔵（`lib/data/badge_definitions.dart`）に移行済み
  - Firestoreルールで write を無効化（既存データ参照用に read のみ残存）
  - 旧フィールド: `name`, `description`, `rarity`, `category`, `isActive`, `order`, `requiredValue`, `imageUrl`, `condition`, `conditionVersion`, `createdBy`, `createdAt`, `updatedAt`

### coupons
- `coupons/{storeId}/coupons/{couponId}`: 店舗別クーポン
  - `couponId`: クーポンID
  - `title`: タイトル
  - `description`: 説明
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `discountType`: 割引種別（割合/固定額/固定価格）
  - `discountValue`: 割引値
  - `validUntil`: 有効期限
  - `requiredStampCount`: 必要スタンプ数（0-10）
  - `noExpiry`: 無期限フラグ
  - `noUsageLimit`: 発行枚数無制限フラグ（trueの場合、usageLimitは0で保存）
  - `usageLimit`: 使用上限回数
  - `usedCount`: 使用済み回数
  - `viewCount`: 表示回数
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `imageUrl`: 画像URL
  - `usedBy/{userId}`: 使用済みユーザー履歴
    - `userId`: 使用者UID
    - `usedAt`: 使用日時
    - `couponId`: クーポンID
    - `storeId`: 店舗ID
    - `orderId`: 注文ID（任意）
- アクセス制御メモ（`firestore.rules`）:
  - クーポン管理権限は `canManageStoreCoupons(storeId)` で統一
  - `isOwner`: 全店舗のクーポン管理が可能
  - `isStoreOwner`: `createdStores` に含まれる店舗のみ管理可能
  - 適用先: `coupons/{storeId}/coupons/{couponId}` / `coupons/{couponId}` / `public_coupons/{couponId}`

### daily_login_stats
- `daily_login_stats/{dateKey}`: 日次ログインユーザー数統計
  - ドキュメントID: 日付文字列（例: `2026-02-17`）
  - `loginCount`: その日にログインしたユニークユーザー数（`FieldValue.increment(1)` でアトミック更新）
  - `date`: 日付文字列（ドキュメントIDと同値、検索用）

### email_otp
- `email_otp/{uid}`: メール認証OTP
  - `codeHash`: 認証コードのハッシュ
  - `expiresAt`: 有効期限
  - `attempts`: 試行回数
  - `lastSentAt`: 最終送信日時
  - `updatedAt`: 更新日時

### account_deletion_requests
- `account_deletion_requests/{requestId}`: アカウント削除申請
  - `storeId`: 対象店舗ID
  - `storeName`: 店舗名（表示用）
  - `storeIconImageUrl`: 店舗アイコンURL（表示用、nullable）
  - `storeCategory`: 店舗カテゴリ（表示用）
  - `userId`: 申請者UID
  - `reason`: 退会理由
  - `status`: 対応状況（pending/approved/rejected）
  - `createdAt`: 申請日時
  - `updatedAt`: 更新日時
  - `processedAt`: 処理日時（nullable）
  - `processedBy`: 処理した管理者UID（nullable）

### feedback
- `feedback/{feedbackId}`: フィードバック
  - `userId`: 投稿者UID
  - `userName`: 投稿者名
  - `userEmail`: 返信先メール
  - `subject`: 件名
  - `message`: 本文
  - `category`: カテゴリ
  - `status`: 対応状況（pending/reviewed/resolved）
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
- アクセス制御メモ（`firestore.rules`）:
  - read: 認証済みユーザーは全件読み取り可能
  - create: 認証済みユーザーはフィードバック送信可能
  - update: `isOwner` のみステータス更新可能
  - delete: 禁止

### service_chat_rooms
- `service_chat_rooms/{roomId}`: サービス全体のライブチャット（ユーザーごと）
  - `roomId`: ルームID（推奨: `userId`）
  - `userId`: ユーザーUID
  - `lastMessage`: 最終メッセージ本文
  - `lastMessageAt`: 最終メッセージ日時
  - `lastSenderRole`: 最終送信者（`user`/`owner`）
  - `userUnreadCount`: ユーザー未読数
  - `ownerUnreadCount`: オーナー未読数（全オーナー共通）
  - `userLastReadAt`: ユーザー既読最終日時
  - `ownerLastReadAt`: オーナー既読最終日時（全オーナー共通）
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `messages/{messageId}`: ライブチャットメッセージ
    - `messageId`: メッセージID
    - `roomId`: ルームID
    - `userId`: ユーザーUID
    - `senderId`: 送信者UID
    - `senderRole`: 送信者（`user`/`owner`）
    - `text`: メッセージ本文
    - `createdAt`: 作成日時
    - `readByUserAt`: ユーザー既読日時
    - `readByOwnerAt`: オーナー既読日時

### news
- `news/{newsId}`: ニュース
  - `id`: ニュースID
  - `title`: タイトル
  - `content`: テキスト本文
  - `imageUrl`: 画像URL（1:1比率）
  - `publishStartDate`: 掲載開始日
  - `publishEndDate`: 掲載終了日
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### notifications
- `notifications/{notificationId}`: 全体お知らせ
  - `notificationId`: お知らせID
  - `title`: タイトル
  - `content`: 本文
  - `category`: カテゴリ
  - `priority`: 優先度
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `isPublished`: 公開フラグ
  - `scheduledDate`: 予約公開日時
  - `publishedAt`: 公開日時
  - `readCount`: 既読数
  - `totalViews`: 閲覧数
  - `tags`: タグ

### owner_settings
- `owner_settings/current`: オーナー設定
  - `basePointReturnRate`: 基本還元率
  - `levelPointReturnRateRanges`: レベル別還元率（`minLevel`, `maxLevel`, `rate`）
  - `friendCampaignStartDate`: 友達紹介開始日
  - `friendCampaignEndDate`: 友達紹介終了日
  - `friendCampaignPoints`: 友達紹介付与ポイント
  - `storeCampaignStartDate`: 店舗紹介開始日
  - `storeCampaignEndDate`: 店舗紹介終了日
  - `storeCampaignPoints`: 店舗紹介付与ポイント
  - `lotteryCampaignStartDate`: スロットキャンペーン開始日
  - `lotteryCampaignEndDate`: スロットキャンペーン終了日
  - `maintenanceStartDate`: メンテナンス開始日
  - `maintenanceEndDate`: メンテナンス終了日
  - `maintenanceStartTime`: メンテ開始時刻
  - `maintenanceEndTime`: メンテ終了時刻
  - `minRequiredVersion`: 店舗アプリ必須バージョン
  - `latestVersion`: 店舗アプリ最新バージョン
  - `iosStoreUrl`: 店舗アプリApp Store URL
  - `androidStoreUrl`: 店舗アプリGoogle Play URL
  - `userMinRequiredVersion`: ユーザーアプリ必須バージョン
  - `userLatestVersion`: ユーザーアプリ最新バージョン
  - `userIosStoreUrl`: ユーザーApp Store URL
  - `userAndroidStoreUrl`: ユーザーGoogle Play URL
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### point_history
- `point_history/{historyId}`: 店舗側の手動付与履歴
  - `userId`: 対象ユーザーUID
  - `storeId`: 店舗ID
  - `points`: 付与ポイント
  - `type`: 種別（earned/spent/expired）
  - `reason`: 理由
  - `timestamp`: 発生日時
  - `createdAt`: 作成日時

### point_ledger
- `point_ledger/{ledgerId}`: 友達紹介ポイント台帳
  - `userId`: 付与対象UID
  - `amount`: 付与ポイント
  - `category`: ポイント種別
  - `reason`: 付与理由
  - `relatedUserId`: 関連ユーザーUID
  - `refId`: 関連ドキュメントID
  - `createdAt`: 作成日時

### point_requests
- `point_requests/{storeId}/{userId}/award_request`: スタンプ押印リクエスト（ポイント付与は行わない）
  - `status`: 状態（pending/accepted/rejected）
  - `requestType`: `stamp`
  - `pointsToAward`: 0
  - `userPoints`: 0
  - `amount`: 0
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `userId`: ユーザーID
  - `usedPoints`: 0
  - `selectedCouponIds`: 使用クーポンID
  - `createdAt`: 作成日時
  - `respondedAt`: 応答日時
  - `respondedBy`: 応答者UID
  - `userNotified`: 通知済みフラグ
  - `userNotifiedAt`: 通知日時
- `point_requests/{storeId}/{userId}/usage_request`: 利用承認リクエスト
  - `status`: 状態（usage_pending_user_approval など）
  - `requestType`: `usage`
  - `usageApprovalNotified`: 通知済みフラグ
  - `usageApprovalNotifiedAt`: 通知日時
  - `usageExpiredAt`: 期限切れ日時

### point_transactions
- `point_transactions/{storeId}/{userId}/{transactionId}`: 店舗別ポイント取引
  - `transactionId`: 取引ID
  - `userId`: ユーザーUID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `amount`: 付与/使用ポイント（使用はマイナス）
  - `paymentAmount`: 会計金額
  - `status`: ステータス
  - `paymentMethod`: 決済手段
  - `description`: 説明
  - `usedSpecialPoints`: 特別ポイント使用数
  - `usedNormalPoints`: 通常ポイント使用数
  - `totalUsedPoints`: 使用合計
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### posts
- `posts/{storeId}/posts/{postId}`: 店舗投稿
  - `postId`: 投稿ID
  - `title`: タイトル（現在は空文字で保存）
  - `content`: 本文
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `storeIconImageUrl`: 店舗アイコン
  - `category`: カテゴリ（店舗ジャンルを保存）
  - `storeCategory`: 店舗ジャンル（表示用、店舗の`category`から取得）
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `isPublished`: 公開フラグ
  - `views`: 閲覧数
  - `viewCount`: 表示回数
  - `comments`: コメント配列
  - `imageUrls`: 画像URL配列
  - `imageCount`: 画像数

### lottery_history
- `lottery_history/{lotteryId}`: スロット履歴
  - `userId`: ユーザーUID
  - `date`: 日付（yyyy-MM-dd）
  - `result`: 等級ラベル（`1等`/`2等`/`ハズレ`）
  - `prize`: 景品説明テキスト
  - `coins`: 獲得コイン数
  - `coinsDelta`: コイン差分（獲得 - 消費）
  - `couponCount`: 獲得クーポン枚数
  - `number`: スロット出目（3桁文字列）
  - `timestamp`: 記録日時

### instagram_posts
- `stores/{storeId}/instagram_posts/{instagramPostId}`: 店舗別Instagram投稿（ユーザー表示用）
  - `instagramPostId`: Instagram投稿ID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `storeIconImageUrl`: 店舗アイコン
  - `mediaType`: 種別（IMAGE/VIDEO/CAROUSEL）
  - `mediaUrl`: 画像/動画URL
  - `thumbnailUrl`: 動画サムネURL
  - `imageUrls`: 表示用画像URL配列（カルーセル対応）
  - `caption`: キャプション
  - `permalink`: Instagram投稿URL
  - `timestamp`: 投稿日時
  - `isVideo`: 動画判定
  - `isActive`: 有効フラグ
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### recommendation_clicks
- `recommendation_clicks/{clickId}`: レコメンドクリック記録
  - `userId`: ユーザーUID
  - `sourceStoreId`: スタンプ押印元店舗ID（任意、stamp_recommendation時のみ）
  - `targetStoreId`: クリック先店舗ID
  - `triggerType`: トリガー種別（`stamp_recommendation` / `daily_login_recommendation`）
  - `impressionId`: 表示記録ID
  - `clickedAt`: クリック日時
  - `distanceMeters`: 距離（メートル、任意）

### recommendation_impressions
- `recommendation_impressions/{impressionId}`: レコメンド表示記録
  - `userId`: ユーザーUID
  - `sourceStoreId`: スタンプ押印元店舗ID（任意、stamp_recommendation時のみ）
  - `targetStoreId`: レコメンド先店舗ID
  - `triggerType`: トリガー種別（`stamp_recommendation` / `daily_login_recommendation`）
  - `algorithmVersion`: アルゴリズムバージョン（`v1`）
  - `reason`: レコメンド理由
  - `shownAt`: 表示日時
  - `distanceMeters`: 距離（メートル、任意）

### public_coupons
- `public_coupons/{couponId}`: ユーザー向け公開クーポン
  - `key`: `storeId::couponId`
  - `couponId`: クーポンID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `title`: タイトル
  - `description`: 説明
  - `discountType`: 割引種別
  - `discountValue`: 割引値
  - `validUntil`: 有効期限
  - `requiredStampCount`: 必要スタンプ数（0-10）
  - `noExpiry`: 無期限フラグ
  - `noUsageLimit`: 発行枚数無制限フラグ（trueの場合、usageLimitは0で保存）
  - `usageLimit`: 使用上限回数
  - `usedCount`: 使用済み回数
  - `viewCount`: 表示回数
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `imageUrl`: 画像URL
- アクセス制御メモ:
  - `coupons` と同じ `canManageStoreCoupons(storeId)` 判定で作成/更新/削除を実行

### public_posts
- `public_posts/{postId}`: ユーザー向け公開投稿
  - `key`: `storeId::postId`
  - `postId`: 投稿ID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `storeIconImageUrl`: 店舗アイコン
  - `title`: タイトル（現在は空文字で保存）
  - `content`: 本文
  - `category`: カテゴリ（店舗ジャンルを保存）
  - `storeCategory`: 店舗ジャンル（表示用、店舗の`category`から取得）
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `isPublished`: 公開フラグ
  - `views`: 閲覧数
  - `viewCount`: 表示回数
  - `comments`: コメント配列
  - `imageUrls`: 画像URL配列
  - `imageCount`: 画像数

### public_instagram_posts
- `public_instagram_posts/{instagramPostId}`: ユーザー向け公開Instagram投稿
  - `key`: `storeId::instagramPostId`
  - `instagramPostId`: Instagram投稿ID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `storeIconImageUrl`: 店舗アイコン
  - `mediaType`: 種別（IMAGE/VIDEO/CAROUSEL）
  - `mediaUrl`: 画像/動画URL
  - `thumbnailUrl`: 動画サムネURL
  - `imageUrls`: 表示用画像URL配列（カルーセル対応）
  - `caption`: キャプション
  - `permalink`: Instagram投稿URL
  - `timestamp`: 投稿日時
  - `isVideo`: 動画判定
  - `isActive`: 有効フラグ
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `likeCount`: いいね数
  - `likedBy`: いいねユーザーUID配列
  - `viewCount`: 閲覧数
  - サブコレクション:
    - `comments/{commentId}`: コメント
      - `userId`: ユーザーID
      - `userName`: ユーザー名
      - `content`: コメント内容
      - `createdAt`: 作成日時
    - `likes/{likeId}`: いいね
      - `userId`: ユーザーID
      - `createdAt`: 作成日時
    - `views/{userId}`: 閲覧記録
      - `userId`: ユーザーID
      - `userName`: ユーザー名
      - `viewedAt`: 閲覧日時
      - `postId`: 投稿ID
      - `postTitle`: 投稿タイトル

### sales
- `sales/{saleId}`: 売上記録（ポイント付与リクエスト作成時）
  - `storeId`: 店舗ID
  - `amount`: 会計金額
  - `requestId`: リクエストID
  - `source`: 記録元
  - `timestamp`: サーバー時刻
  - `createdAt`: 作成日時

### store_stats
- `store_stats/{storeId}/daily/{yyyy-mm-dd}`: 日別店舗集計
  - `date`: 日付キー
  - `pointsIssued`: 付与ポイント
  - `pointsUsed`: 使用ポイント
  - `totalPointsAwarded`: 付与合計
  - `totalSales`: 売上合計
  - `totalTransactions`: 取引回数
  - `visitorCount`: 来店人数
  - `lastUpdated`: 更新日時

### store_users
- `store_users/{storeId}/users/{userId}`: 店舗来店ユーザー集計
  - `userId`: ユーザーUID
  - `storeId`: 店舗ID
  - `firstVisitAt`: 初回来店
  - `lastVisitAt`: 最終来店
  - `totalVisits`: 来店回数
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### stores
- `stores/{storeId}`: 店舗マスタ
  - `storeId`: 店舗ID
  - `name`: 店舗名
  - `businessType`: 経営形態（`individual`/`corporate`）
  - `businessName`: 法人名または代表者名
  - `category`: カテゴリ
  - `subCategory`: サブカテゴリ（任意）
  - `address`: 住所
  - `phone`: 電話番号
  - `description`: 店舗説明
  - `ownerId`: オーナーUID
  - `createdBy`: 店舗作成者UID（実運用での所有者参照キー）
  - `isRegularHoliday`: 不定休フラグ（true/false）
  - `isActive`: 店舗公開フラグ（初期値false。5項目（店舗プロフィール・位置情報・メニュー・店内画像・決済方法）全完了で自動true。設定画面のトグルでも切り替え可能）
  - `isApproved`: 承認フラグ（承認ボタンでtrue）
  - `approvalStatus`: 承認ステータス（`pending`/`approved`/`rejected`）
  - `approvedAt`: 承認日時
  - `approvedBy`: 承認者UID
  - `rejectedAt`: 拒否日時
  - `rejectedBy`: 拒否者UID
  - `pendingRequestNotifiedAt`: 未承認店舗通知送信済み日時
  - 表示ルール（ユーザーアプリ）: マップ/店舗一覧は `isActive=true` かつ `isApproved=true` の店舗のみ表示し、`stores.isOwner=true` または `createdBy` の `users.isOwner=true` に該当する店舗は非表示
  - `businessHours`: 営業時間（曜日ごとの `open/close/isOpen`）
  - `socialMedia`: SNSリンク（`instagram`, `x`, `facebook`, `website`）
  - `instagramAuth`: Instagram連携情報（Functions用）
    - `instagramUserId`: InstagramビジネスアカウントID
    - `accessToken`: アクセストークン（長期）
    - `username`: Instagramユーザー名（任意）
    - `tokenExpiresAt`: 有効期限（任意）
  - `instagramSync`: Instagram同期情報
    - `lastSyncAt`: 最終同期日時
    - `lastSyncCount`: 最終同期取得件数
  - `tags`: タグ
  - `paymentMethods`: 利用可能な決済方法（カテゴリ別Map）
    - `cash`: 現金カテゴリ
      - `cash`: 現金（bool）
    - `card`: クレジット/デビット/プリペイドカテゴリ
      - `visa`, `mastercard`, `jcb`, `amex`, `diners`, `discover`: 各ブランド（bool）
      - `unionpay_card`: UnionPay（銀聯）カード（bool）
      - `debit`: デビットカード（bool）
      - `prepaid`: プリペイドカード（bool）
      - `contactless`: タッチ決済/NFC（bool）
      - `apple_pay_touch`: Apple Pay タッチ決済（bool）
      - `google_pay_touch`: Google Pay タッチ決済（bool）
    - `emoney`: 電子マネーカテゴリ
      - `transit_ic`: 交通系IC（bool）
      - `id`: iD（bool）
      - `quicpay`: QUICPay（bool）
      - `rakuten_edy`: 楽天Edy（bool）
      - `nanaco`: nanaco（bool）
      - `waon`: WAON（bool）
    - `qr`: QR/バーコード決済カテゴリ
      - `paypay`, `d_barai`, `rakuten_pay`, `au_pay`, `merpay`: 各サービス（bool）
      - `wechat_pay`, `alipay_plus`, `unionpay_qr`: 海外系（bool）
      - `coin_plus`, `j_coin_pay`, `smart_code`, `bank_pay`, `yucho_pay`: その他（bool）
  - `facilityInfo`: 設備・サービス情報
    - `seatingCapacity`: 座席数（種別ごと）
      - `counter`: カウンター席数（int）
      - `table`: テーブル席数（int）
      - `tatami`: 座敷席数（int）
      - `terrace`: テラス席数（int）
      - `privateRoom`: 個室数（int）
      - `sofa`: ソファー席数（int）
    - `parking`: 駐車場（`none`/`free`/`paid`/`nearby`）
    - `accessInfo`: 最寄り駅・アクセス情報（String）
    - `takeout`: テイクアウト対応（bool）
    - `smokingPolicy`: 喫煙ポリシー（`no_smoking`/`smoking`/`separated`/`e_cigarette_only`）
    - `hasWifi`: Wi-Fi有無（bool）
    - `barrierFree`: バリアフリー対応（bool）
    - `childFriendly`: お子様連れ歓迎（bool）
    - `petFriendly`: ペット同伴可（bool）
  - `location`: 位置（`latitude`, `longitude`）
  - `notificationSettings`: 店舗プッシュ通知設定
    - `newVisitor`: 新規来店者通知の有効フラグ
    - `couponUsage`: クーポン使用通知の有効フラグ
    - `feedback`: フィードバック通知の有効フラグ
    - `updatedAt`: 更新日時
  - `emailNotificationSettings`: 店舗メール通知設定
    - `system`: システム通知の有効フラグ
    - `promotions`: プロモーション通知の有効フラグ
    - `updatedAt`: 更新日時
  - `iconImageUrl`: アイコン画像
  - `storeImageUrl`: 店舗画像
  - `createdBy`: 作成者UID
  - `updatedAt`: 更新日時
  - `transactions/{transactionId}`: 店舗取引履歴
    - `type`: `award`/`use`/`stamp`（stampはスタンプ押印来店記録）
    - `points`: 付与/使用ポイント（stampの場合は0）
    - `amountYen`: 会計金額（stampの場合は0）
    - `paymentMethod`: 決済手段
    - `status`: ステータス
    - `source`: 記録元（`point_request`/`point_usage`/`stamp_punch`）
    - `approvedBy`: 承認者UID
    - `usedSpecialPoints`: 特別ポイント使用数
    - `usedNormalPoints`: 通常ポイント使用数
    - `totalUsedPoints`: 使用合計
    - `createdAt`: 作成日時
    - `createdAtClient`: 端末時刻
    - `userGender`: ユーザー性別（トランザクション時点のスナップショット）
    - `userAgeGroup`: ユーザー年代グループ（`~19`/`20s`/`30s`/`40s`/`50s`/`60+`）
    - `userPrefecture`: ユーザー都道府県（トランザクション時点のスナップショット）
    - `userCity`: ユーザー市区町村（トランザクション時点のスナップショット）
  - `menu/{menuId}`: メニュー
    - `id`: メニューID
    - `name`: メニュー名
    - `description`: 説明
    - `price`: 価格
    - `category`: カテゴリ
    - `imageUrl`: 画像URL
    - `isAvailable`: 提供中フラグ
    - `sortOrder`: 並び順
    - `createdAt`: 作成日時
    - `updatedAt`: 更新日時
  - `interior_images/{imageId}`: 店内画像
    - `imageUrl`: 画像URL
    - `caption`: 説明テキスト（20文字以内）
    - `sortOrder`: 並び順
    - `isActive`: 表示フラグ
    - `createdAt`: 作成日時
    - `updatedAt`: 更新日時
  - `followers/{userId}`: 店舗フォロワー
    - `userId`: ユーザーUID
    - `userName`: ユーザー表示名
    - `followedAt`: フォロー日時

### user_coupons
- `user_coupons/{userCouponId}`: ユーザー取得クーポン
  - `userId`: ユーザーUID
  - `couponId`: クーポンID
  - `obtainedAt`: 取得日時
  - `usedAt`: 使用日時（使用済みの場合）
  - `isUsed`: 使用済みフラグ
  - `storeId`: 店舗ID
  - `orderId`: 注文ID（任意）
  - `storeName`: 店舗名（コイン交換クーポン時）
  - `type`: クーポン種別（`coin_exchange` = コイン交換クーポン）
  - `title`: クーポン名（例: `100円引きクーポン`）
  - `discountValue`: 割引値（例: 100）
  - `discountType`: 割引種別（`fixed_amount` = 固定額）
  - `validFrom`: 有効開始日時（Timestamp）
  - `validUntil`: 有効期限（Timestamp、コイン交換の場合は取得日+30日）

### user_achievement_events
- `user_achievement_events/{userId}/events/{eventId}`: 実績イベント
  - `type`: 種別（`point_award` / `stamp_punch`）
  - `transactionId`: 取引ID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `pointsAwarded`: 付与ポイント
  - `stampsAdded`: 追加スタンプ
  - `stampsAfter`: 付与後スタンプ
  - `cardCompleted`: カード完了フラグ
  - `badges`: 付与バッジ配列
  - `createdAt`: 作成日時
  - `seenAt`: 既読日時
  - `coinBonusAwarded`: 来店ボーナスコイン付与済みフラグ（bool、二重付与防止用）

### badge_progress
- `badge_progress/{userId}_{counterKey}`: バッジ進捗カウンター（アクション系バッジの累積回数を記録）
  - `userId`: ユーザーUID
  - `badgeType`: カウンターキー（BadgeType名: `mapOpened`, `storeDetailViewed`, `favoriteAdded`, `slotPlayed`, `slotWin`, `couponUsed`, `likeGiven`, `commentPosted`, `followUser`, `coinsEarned`, `missionCompleted`, `recommendViewed`, `stampCardCompleted`, `specialEvents`）
  - `currentValue`: 現在値（`FieldValue.increment(1)` でアトミック更新）
  - `lastUpdated`: 最終更新日時
- 書き込みタイミング: 各アクション実行時に `BadgeService().incrementBadgeCounter()` で自動記録
- インクリメント後に即座にバッジ判定を実行し、条件達成時は `user_badges` に `isNew: true` で書き込み

### user_badges
- `user_badges/{userId}/badges/{badgeId}`: ユーザー獲得バッジ
  - `userId`: ユーザーUID
  - `badgeId`: バッジID（`lib/data/badge_definitions.dart` の badgeId と対応）
  - `name`: バッジ名
  - `description`: バッジ説明
  - `iconUrl`: アイコン画像パス
  - `rarity`: レア度（`common` / `rare` / `epic` / `legendary`）
  - `unlockedAt`: 獲得日時
  - `progress`: 獲得時の進捗値
  - `requiredValue`: 獲得条件の閾値
  - `isNew`: 新規フラグ（未読バッジ表示用、`markBadgesAsSeen` で false に一括更新）

### user_point_balances
- `user_point_balances/{userId}`: ユーザーのポイント残高
  - `userId`: ユーザーUID
  - `totalPoints`: 累計ポイント
  - `availablePoints`: 利用可能ポイント
  - `usedPoints`: 使用済みポイント
  - `lastUpdated`: 更新日時
  - `lastUpdatedByStoreId`: 更新した店舗ID

### usernames
- `usernames/{username}`: ユーザーIDユニーク制約用コレクション
  - ドキュメントID: ユーザーIDの小文字（ユニーク制約を実現）
  - `uid`: 所有者のユーザーUID
  - 新規登録時にデフォルトユーザーID（`user_` + UIDの先頭8文字）が自動登録される
- アクセス制御メモ:
  - 認証済みユーザーは読み取り可能
  - 作成は自分の`uid`を含むドキュメントのみ
  - 削除は自分が所有するドキュメントのみ

### users
- `users/{userId}`: ユーザープロフィール/状態
  - `uid`: ユーザーUID
  - `email`: メールアドレス
  - `displayName`: 表示名（新規登録時のデフォルト値: `ユーザー`。Googleサインインの場合はGoogleアカウント名）
  - `username`: ユーザーID（ユニーク、英数字+アンダースコア、3〜20文字、`usernames`コレクションで重複防止。新規登録時のデフォルト値: `user_` + UIDの先頭8文字（小文字）。`usernames`コレクションに自動登録）
  - `bio`: 自己紹介（最大100文字）
  - `occupation`: 職業（`学生`/`会社員`/`公務員`/`自営業`/`フリーランス`/`パート・アルバイト`/`主婦・主夫`/`その他`）
  - `interestCategories`: 興味のあるカテゴリ（List<String>、CATEGORY_LIST.mdのカテゴリ名）
  - `emailVerified`: メール認証フラグ
  - `emailVerifiedAt`: メール認証日時
  - `emailOtpRequired`: ログイン時OTP必須フラグ
  - `authProvider`: 認証プロバイダ
  - `isOwner`: オーナー判定
  - `isStoreOwner`: 店舗アカウント判定
  - `createdStores`: 作成店舗ID配列
  - `currentStoreId`: 選択中の店舗ID
  - `points`: 通常ポイント
  - `specialPoints`: 特別ポイント
  - `specialPointsTotal`: 特別ポイント累計
  - `totalPoints`: 総ポイント
  - `pointReturnRate`: 還元率
  - `paid`: 支払累計
  - `rank`: ランク
  - `currentLevel`: レベル（廃止済み・既存データのみ）
  - `level`: レベル（廃止済み・既存データのみ）
  - `experience`: 経験値（廃止済み・既存データのみ）
  - `badgeCount`: 獲得バッジ数
  - `earnedBadges`: 獲得バッジID配列
  - `referralCode`: 友達紹介コード
  - `referralCount`: 招待数
  - `referralEarnings`: 紹介獲得ポイント
  - `referralEarningsPoints`: 紹介獲得ポイント合計
  - `referralUsed`: 紹介コード利用済み
  - `storeReferralCode`: 店舗紹介コード
  - `storeReferralCount`: 店舗紹介数
  - `storeReferralEarnings`: 店舗紹介獲得ポイント
  - `favoriteStoreIds`: お気に入り店舗ID配列
  - `followedStoreIds`: フォロー中店舗ID配列
  - `fcmToken`: 端末FCMトークン
  - `fcmTokenUpdatedAt`: FCM更新日時
  - `profileImageUrl`: プロフィール画像
  - `gender`: 性別（`男性`/`女性`/`その他`/`回答しない`）
  - `birthDate`: 生年月日（DateTime）
  - `prefecture`: 都道府県
  - `city`: 市区町村
  - `friendReferralPopupShown`: 紹介通知表示済み
  - `friendReferralPopup`: 紹介通知データ
  - `friendReferralPopupReferrerShown`: 紹介者側通知表示済み
  - `friendReferralPopupReferrer`: 紹介者側通知データ
  - `notificationSettings`: 通知設定
    - `pushEnabled`: プッシュ通知の有効フラグ
    - `couponIssued`: クーポン発行通知の有効フラグ
    - `post`: 投稿通知の有効フラグ
    - `updatedAt`: 更新日時
  - `emailNotificationSettings`: メール通知設定
    - `announcements`: お知らせメールの有効フラグ
    - `newsletters`: ニュースレターの有効フラグ
    - `promotions`: キャンペーン・プロモーションの有効フラグ
    - `updatedAt`: 更新日時
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `lastLoginAt`: 最終ログイン
  - `lastUpdated`: 最終更新（ランキング用）
  - `lastUpdatedByStoreId`: 更新店舗ID
  - `isActive`: 利用中フラグ
  - `coins`: コイン残高
  - `loginStreak`: 連続ログイン日数（int）
  - `lastLoginDate`: 連続ログイン判定用の最終ログイン日（yyyy-MM-dd）
  - `missionProgress`: ミッション進捗（Map）
    - `profile_completed`: プロフィール完成達成フラグ（bool）
    - `profile_claimed`: プロフィール完成報酬受取済みフラグ（bool）
    - `first_map`: マップ初利用達成フラグ（bool）
    - `first_map_claimed`: マップ初利用報酬受取済みフラグ（bool）
    - `first_favorite`: お気に入り登録達成フラグ（bool）
    - `first_favorite_claimed`: お気に入り登録報酬受取済みフラグ（bool）
    - `first_store_detail`: 店舗詳細閲覧達成フラグ（bool）
    - `first_store_detail_claimed`: 店舗詳細閲覧報酬受取済みフラグ（bool）
    - `first_stamp`: スタンプ初獲得達成フラグ（bool）
    - `first_stamp_claimed`: スタンプ初獲得報酬受取済みフラグ（bool）
    - `login_3_claimed`: 3日連続ログインボーナス受取済みフラグ（bool）
    - `login_7_claimed`: 7日連続ログインボーナス受取済みフラグ（bool）
    - `login_30_claimed`: 30日連続ログインボーナス受取済みフラグ（bool）
  - `showTutorial`: チュートリアル表示
  - `readNotifications`: 既読通知ID配列
  - `stores/{storeId}`: スタンプ/来店情報
    - `stamps`: スタンプ数
    - `lastVisited`: 最終来店
    - `totalSpending`: 累計支出
    - `updatedAt`: 更新日時
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
  - `used_coupons/{couponId}`: 使用済みクーポン
    - `userId`: ユーザーUID
    - `usedAt`: 使用日時
    - `couponId`: クーポンID
    - `storeId`: 店舗ID
    - `orderId`: 注文ID（任意）
  - `liked_posts/{postId}`: いいね履歴
    - `postId`: 投稿ID
    - `postTitle`: 投稿タイトル
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
    - `likedAt`: いいね日時
  - `favorite_stores/{storeId}`: お気に入り店舗
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
    - `category`: カテゴリ
    - `storeImageUrl`: 店舗画像
    - `favoritedAt`: お気に入り日時
  - `followed_stores/{storeId}`: フォロー中店舗（来店時自動フォロー / 手動フォロー）
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
    - `category`: カテゴリ
    - `storeImageUrl`: 店舗画像
    - `followedAt`: フォロー日時
    - `source`: フォロー経路（`stamp` = スタンプ自動 / `manual` = 手動）
  - `comments/{commentId}`: コメント履歴
    - `commentId`: コメントID
    - `postId`: 投稿ID
    - `storeId`: 店舗ID
    - `postTitle`: 投稿タイトル
    - `content`: コメント内容
    - `createdAt`: 作成日時
  - `notifications/{notificationId}`: ユーザー通知
    - `id`: 通知ID
    - `title`: タイトル
    - `body`: 本文
    - `type`: 種別
    - `createdAt`: 作成日時
    - `isRead`: 既読フラグ
    - `isDelivered`: 配信済み
    - `data`: 付帯データ
    - `tags`: タグ
  - `map_filter/settings`: マップフィルター設定
    - `showOpenNowOnly`: 営業中のみ表示（bool）
    - `selectedCategories`: 選択カテゴリ（List<string>、空=全表示）
    - `explorationStatus`: 開拓状態（List<string>: 'unvisited'/'exploring'/'regular'、空=全表示）
    - `favoritesOnly`: お気に入りのみ表示（bool）
    - `paymentMethodCategories`: 決済方法カテゴリ（List<string>: 'cash'/'card'/'emoney'/'qr'）
    - `hasCoupon`: クーポンあり店舗のみ（bool）
    - `hasAvailableCoupon`: 利用可能クーポンあり店舗のみ（bool）
    - `maxDistanceKm`: 最大距離km（number、null=制限なし）
    - `updatedAt`: 更新日時
  - `daily_missions/{yyyy-MM-dd}`: デイリーミッション（日付ごと）
    - `app_open`: アプリを開く達成フラグ（bool）
    - `app_open_claimed`: アプリを開く報酬受取済みフラグ（bool）
    - `recommendation_view`: レコメンドを見る達成フラグ（bool）
    - `recommendation_view_claimed`: レコメンドを見る報酬受取済みフラグ（bool）
    - `feed_view`: 投稿を1件見る達成フラグ（bool）
    - `feed_view_claimed`: 投稿を1件見る報酬受取済みフラグ（bool）
