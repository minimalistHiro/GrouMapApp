# FIRESTORE.md

## Firestore: コレクション一覧（abc順・コード参照ベース）

### badges
- `badges/{badgeId}`: バッジ定義
  - `name`: バッジ名
  - `description`: バッジ説明
  - `rarity`: レア度
  - `category`: 分類
  - `isActive`: 有効フラグ
  - `order`: 表示順
  - `requiredValue`: 条件の閾値
  - `imageUrl`: 画像URL
  - `condition`: 条件（typed/jsonlogic）
  - `conditionVersion`: 条件のバージョン
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### coupons
- `coupons/{storeId}/coupons/{couponId}`: 店舗別クーポン
  - `couponId`: クーポンID
  - `title`: タイトル
  - `description`: 説明
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `discountType`: 割引種別（割合/固定額/固定価格）
  - `discountValue`: 割引値
  - `validUntil`: 有効期限
  - `requiredStampCount`: 必要スタンプ数（0-10）
  - `noExpiry`: 無期限フラグ
  - `usageLimit`: 使用上限回数
  - `usedCount`: 使用済み回数
  - `viewCount`: 表示回数
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `imageUrl`: 画像URL
  - `usedBy/{userId}`: 使用済みユーザー履歴
    - `userId`: 使用者UID
    - `usedAt`: 使用日時
    - `couponId`: クーポンID
    - `storeId`: 店舗ID

### email_otp
- `email_otp/{uid}`: メール認証OTP
  - `codeHash`: 認証コードのハッシュ
  - `expiresAt`: 有効期限
  - `attempts`: 試行回数
  - `lastSentAt`: 最終送信日時
  - `updatedAt`: 更新日時

### feedback
- `feedback/{feedbackId}`: フィードバック
  - `userId`: 投稿者UID
  - `userName`: 投稿者名
  - `userEmail`: 返信先メール
  - `subject`: 件名
  - `message`: 本文
  - `category`: カテゴリ
  - `status`: 対応状況（pending/reviewed/resolved）
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### notifications
- `notifications/{notificationId}`: 全体お知らせ
  - `notificationId`: お知らせID
  - `title`: タイトル
  - `content`: 本文
  - `category`: カテゴリ
  - `priority`: 優先度
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `isPublished`: 公開フラグ
  - `scheduledDate`: 予約公開日時
  - `publishedAt`: 公開日時
  - `readCount`: 既読数
  - `totalViews`: 閲覧数
  - `tags`: タグ

### owner_settings
- `owner_settings/current`: オーナー設定
  - `basePointReturnRate`: 基本還元率
  - `levelPointReturnRateRanges`: レベル別還元率（`minLevel`, `maxLevel`, `rate`）
  - `friendCampaignStartDate`: 友達紹介開始日
  - `friendCampaignEndDate`: 友達紹介終了日
  - `friendCampaignPoints`: 友達紹介付与ポイント
  - `storeCampaignStartDate`: 店舗紹介開始日
  - `storeCampaignEndDate`: 店舗紹介終了日
  - `storeCampaignPoints`: 店舗紹介付与ポイント
  - `maintenanceStartDate`: メンテナンス開始日
  - `maintenanceEndDate`: メンテナンス終了日
  - `maintenanceStartTime`: メンテ開始時刻
  - `maintenanceEndTime`: メンテ終了時刻
  - `minRequiredVersion`: 店舗アプリ必須バージョン
  - `latestVersion`: 店舗アプリ最新バージョン
  - `iosStoreUrl`: 店舗アプリApp Store URL
  - `androidStoreUrl`: 店舗アプリGoogle Play URL
  - `userMinRequiredVersion`: ユーザーアプリ必須バージョン
  - `userLatestVersion`: ユーザーアプリ最新バージョン
  - `userIosStoreUrl`: ユーザーApp Store URL
  - `userAndroidStoreUrl`: ユーザーGoogle Play URL
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### point_history
- `point_history/{historyId}`: 店舗側の手動付与履歴
  - `userId`: 対象ユーザーUID
  - `storeId`: 店舗ID
  - `points`: 付与ポイント
  - `type`: 種別（earned/spent/expired）
  - `reason`: 理由
  - `timestamp`: 発生日時
  - `createdAt`: 作成日時

### point_ledger
- `point_ledger/{ledgerId}`: 友達紹介ポイント台帳
  - `userId`: 付与対象UID
  - `amount`: 付与ポイント
  - `category`: ポイント種別
  - `reason`: 付与理由
  - `relatedUserId`: 関連ユーザーUID
  - `refId`: 関連ドキュメントID
  - `createdAt`: 作成日時

### point_requests
- `point_requests/{storeId}/{userId}/award_request`: スタンプ押印リクエスト（ポイント付与は行わない）
  - `status`: 状態（pending/accepted/rejected）
  - `requestType`: `stamp`
  - `pointsToAward`: 0
  - `userPoints`: 0
  - `amount`: 0
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `userId`: ユーザーID
  - `usedPoints`: 0
  - `selectedCouponIds`: 使用クーポンID
  - `createdAt`: 作成日時
  - `respondedAt`: 応答日時
  - `respondedBy`: 応答者UID
  - `userNotified`: 通知済みフラグ
  - `userNotifiedAt`: 通知日時
- `point_requests/{storeId}/{userId}/usage_request`: 利用承認リクエスト
  - `status`: 状態（usage_pending_user_approval など）
  - `requestType`: `usage`
  - `usageApprovalNotified`: 通知済みフラグ
  - `usageApprovalNotifiedAt`: 通知日時
  - `usageExpiredAt`: 期限切れ日時

### point_transactions
- `point_transactions/{storeId}/{userId}/{transactionId}`: 店舗別ポイント取引
  - `transactionId`: 取引ID
  - `userId`: ユーザーUID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `amount`: 付与/使用ポイント（使用はマイナス）
  - `paymentAmount`: 会計金額
  - `status`: ステータス
  - `paymentMethod`: 決済手段
  - `description`: 説明
  - `usedSpecialPoints`: 特別ポイント使用数
  - `usedNormalPoints`: 通常ポイント使用数
  - `totalUsedPoints`: 使用合計
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### posts
- `posts/{storeId}/posts/{postId}`: 店舗投稿
  - `postId`: 投稿ID
  - `title`: タイトル
  - `content`: 本文
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `storeIconImageUrl`: 店舗アイコン
  - `category`: カテゴリ
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `isPublished`: 公開フラグ
  - `views`: 閲覧数
  - `viewCount`: 表示回数
  - `comments`: コメント配列
  - `imageUrls`: 画像URL配列
  - `imageCount`: 画像数

### public_coupons
- `public_coupons/{couponId}`: ユーザー向け公開クーポン
  - `key`: `storeId::couponId`
  - `couponId`: クーポンID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `title`: タイトル
  - `description`: 説明
  - `discountType`: 割引種別
  - `discountValue`: 割引値
  - `validUntil`: 有効期限
  - `requiredStampCount`: 必要スタンプ数（0-10）
  - `noExpiry`: 無期限フラグ
  - `usageLimit`: 使用上限回数
  - `usedCount`: 使用済み回数
  - `viewCount`: 表示回数
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `imageUrl`: 画像URL

### public_posts
- `public_posts/{postId}`: ユーザー向け公開投稿
  - `key`: `storeId::postId`
  - `postId`: 投稿ID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `storeIconImageUrl`: 店舗アイコン
  - `title`: タイトル
  - `content`: 本文
  - `category`: カテゴリ
  - `createdBy`: 作成者UID
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `isActive`: 有効フラグ
  - `isPublished`: 公開フラグ
  - `views`: 閲覧数
  - `viewCount`: 表示回数
  - `comments`: コメント配列
  - `imageUrls`: 画像URL配列
  - `imageCount`: 画像数

### sales
- `sales/{saleId}`: 売上記録（ポイント付与リクエスト作成時）
  - `storeId`: 店舗ID
  - `amount`: 会計金額
  - `requestId`: リクエストID
  - `source`: 記録元
  - `timestamp`: サーバー時刻
  - `createdAt`: 作成日時

### store_stats
- `store_stats/{storeId}/daily/{yyyy-mm-dd}`: 日別店舗集計
  - `date`: 日付キー
  - `pointsIssued`: 付与ポイント
  - `pointsUsed`: 使用ポイント
  - `totalPointsAwarded`: 付与合計
  - `totalSales`: 売上合計
  - `totalTransactions`: 取引回数
  - `visitorCount`: 来店人数
  - `lastUpdated`: 更新日時

### store_users
- `store_users/{storeId}/users/{userId}`: 店舗来店ユーザー集計
  - `userId`: ユーザーUID
  - `storeId`: 店舗ID
  - `firstVisitAt`: 初回来店
  - `lastVisitAt`: 最終来店
  - `totalVisits`: 来店回数
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時

### stores
- `stores/{storeId}`: 店舗マスタ
  - `storeId`: 店舗ID
  - `name`: 店舗名
  - `category`: カテゴリ
  - `subCategory`: サブカテゴリ（任意）
  - `address`: 住所
  - `phone`: 電話番号
  - `description`: 店舗説明
  - `isRegularHoliday`: 不定休フラグ（true/false）
  - `isActive`: 店舗公開フラグ（店舗設定画面のトグルで切り替え）
  - `isApproved`: 承認フラグ（承認ボタンでtrue）
  - `approvalStatus`: 承認ステータス（`pending`/`approved`/`rejected`）
  - `approvedAt`: 承認日時
  - `approvedBy`: 承認者UID
  - `rejectedAt`: 拒否日時
  - `rejectedBy`: 拒否者UID
  - `pendingRequestNotifiedAt`: 未承認店舗通知送信済み日時
  - `businessHours`: 営業時間（曜日ごとの `open/close/isOpen`）
  - `socialMedia`: SNSリンク（`instagram`, `x`, `facebook`, `website`）
  - `tags`: タグ
  - `location`: 位置（`latitude`, `longitude`）
  - `iconImageUrl`: アイコン画像
  - `storeImageUrl`: 店舗画像
  - `createdBy`: 作成者UID
  - `updatedAt`: 更新日時
  - `transactions/{transactionId}`: 店舗取引履歴
    - `type`: `award`/`use`
    - `points`: 付与/使用ポイント
    - `amountYen`: 会計金額
    - `paymentMethod`: 決済手段
    - `status`: ステータス
    - `source`: 記録元（`point_request`/`point_usage`）
    - `approvedBy`: 承認者UID
    - `usedSpecialPoints`: 特別ポイント使用数
    - `usedNormalPoints`: 通常ポイント使用数
    - `totalUsedPoints`: 使用合計
    - `createdAt`: 作成日時
    - `createdAtClient`: 端末時刻
  - `menu/{menuId}`: メニュー
    - `id`: メニューID
    - `name`: メニュー名
    - `description`: 説明
    - `price`: 価格
    - `category`: カテゴリ
    - `imageUrl`: 画像URL
    - `isAvailable`: 提供中フラグ
    - `sortOrder`: 並び順
    - `createdAt`: 作成日時
    - `updatedAt`: 更新日時
  - `interior_images/{imageId}`: 店内画像
    - `imageUrl`: 画像URL
    - `caption`: 説明テキスト（20文字以内）
    - `sortOrder`: 並び順
    - `isActive`: 表示フラグ
    - `createdAt`: 作成日時
    - `updatedAt`: 更新日時

### user_achievement_events
- `user_achievement_events/{userId}/events/{eventId}`: 実績イベント
  - `type`: 種別（例: `point_award`）
  - `transactionId`: 取引ID
  - `storeId`: 店舗ID
  - `storeName`: 店舗名
  - `pointsAwarded`: 付与ポイント
  - `stampsAdded`: 追加スタンプ
  - `stampsAfter`: 付与後スタンプ
  - `cardCompleted`: カード完了フラグ
  - `xpAdded`: 追加XP
  - `xpBreakdown`: XP内訳（`points`, `stampPunch`, `cardComplete`）
  - `badges`: 付与バッジ配列
  - `createdAt`: 作成日時
  - `seenAt`: 既読日時

### user_badges
- `user_badges/{userId}/badges/{badgeId}`: ユーザー獲得バッジ
  - `userId`: ユーザーUID
  - `badgeId`: バッジID
  - `unlockedAt`: 獲得日時
  - `isNew`: 新規フラグ
  - `name`: バッジ名
  - `description`: 説明
  - `category`: カテゴリ
  - `imageUrl`: 画像URL
  - `iconUrl`: アイコンURL
  - `iconPath`: アイコンパス
  - `rarity`: レア度
  - `order`: 表示順
  - `progress`: 進捗
  - `requiredValue`: 閾値

### user_point_balances
- `user_point_balances/{userId}`: ユーザーのポイント残高
  - `userId`: ユーザーUID
  - `totalPoints`: 累計ポイント
  - `availablePoints`: 利用可能ポイント
  - `usedPoints`: 使用済みポイント
  - `lastUpdated`: 更新日時
  - `lastUpdatedByStoreId`: 更新した店舗ID

### users
- `users/{userId}`: ユーザープロフィール/状態
  - `uid`: ユーザーUID
  - `email`: メールアドレス
  - `displayName`: 表示名
  - `emailVerified`: メール認証フラグ
  - `emailVerifiedAt`: メール認証日時
  - `emailOtpRequired`: ログイン時OTP必須フラグ
  - `authProvider`: 認証プロバイダ
  - `isOwner`: オーナー判定
  - `isStoreOwner`: 店舗アカウント判定
  - `createdStores`: 作成店舗ID配列
  - `currentStoreId`: 選択中の店舗ID
  - `points`: 通常ポイント
  - `specialPoints`: 特別ポイント
  - `specialPointsTotal`: 特別ポイント累計
  - `totalPoints`: 総ポイント
  - `pointReturnRate`: 還元率
  - `paid`: 支払累計
  - `rank`: ランク
  - `currentLevel`: レベル（初期）
  - `level`: レベル（運用中）
  - `experience`: 経験値
  - `badgeCount`: 獲得バッジ数
  - `earnedBadges`: 獲得バッジID配列
  - `referralCode`: 友達紹介コード
  - `referralCount`: 招待数
  - `referralEarnings`: 紹介獲得ポイント
  - `referralEarningsPoints`: 紹介獲得ポイント合計
  - `referralUsed`: 紹介コード利用済み
  - `storeReferralCode`: 店舗紹介コード
  - `storeReferralCount`: 店舗紹介数
  - `storeReferralEarnings`: 店舗紹介獲得ポイント
  - `favoriteStoreIds`: お気に入り店舗ID配列
  - `fcmToken`: 端末FCMトークン
  - `fcmTokenUpdatedAt`: FCM更新日時
  - `profileImageUrl`: プロフィール画像
  - `friendReferralPopupShown`: 紹介通知表示済み
  - `friendReferralPopup`: 紹介通知データ
  - `friendReferralPopupReferrerShown`: 紹介者側通知表示済み
  - `friendReferralPopupReferrer`: 紹介者側通知データ
  - `notificationSettings`: 通知設定
    - `pushEnabled`: プッシュ通知の有効フラグ
    - `couponIssued`: クーポン発行通知の有効フラグ
    - `post`: 投稿通知の有効フラグ
    - `updatedAt`: 更新日時
  - `emailNotificationSettings`: メール通知設定
    - `announcements`: お知らせメールの有効フラグ
    - `newsletters`: ニュースレターの有効フラグ
    - `promotions`: キャンペーン・プロモーションの有効フラグ
    - `updatedAt`: 更新日時
  - `createdAt`: 作成日時
  - `updatedAt`: 更新日時
  - `lastLoginAt`: 最終ログイン
  - `lastUpdated`: 最終更新（ランキング用）
  - `lastUpdatedByStoreId`: 更新店舗ID
  - `isActive`: 利用中フラグ
  - `showTutorial`: チュートリアル表示
  - `readNotifications`: 既読通知ID配列
  - `stores/{storeId}`: スタンプ/来店情報
    - `stamps`: スタンプ数
    - `lastVisited`: 最終来店
    - `totalSpending`: 累計支出
    - `updatedAt`: 更新日時
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
  - `used_coupons/{couponId}`: 使用済みクーポン
    - `userId`: ユーザーUID
    - `usedAt`: 使用日時
    - `couponId`: クーポンID
    - `storeId`: 店舗ID
  - `liked_posts/{postId}`: いいね履歴
    - `postId`: 投稿ID
    - `postTitle`: 投稿タイトル
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
    - `likedAt`: いいね日時
  - `favorite_stores/{storeId}`: お気に入り店舗
    - `storeId`: 店舗ID
    - `storeName`: 店舗名
    - `category`: カテゴリ
    - `storeImageUrl`: 店舗画像
    - `favoritedAt`: お気に入り日時
  - `comments/{commentId}`: コメント履歴
    - `commentId`: コメントID
    - `postId`: 投稿ID
    - `storeId`: 店舗ID
    - `postTitle`: 投稿タイトル
    - `content`: コメント内容
    - `createdAt`: 作成日時
  - `notifications/{notificationId}`: ユーザー通知
    - `id`: 通知ID
    - `title`: タイトル
    - `body`: 本文
    - `type`: 種別
    - `createdAt`: 作成日時
    - `isRead`: 既読フラグ
    - `isDelivered`: 配信済み
    - `data`: 付帯データ
    - `tags`: タグ
