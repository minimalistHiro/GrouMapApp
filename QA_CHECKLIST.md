# QA チェックリスト

実装・変更後にテスターが確認すべきテスト項目を記載する。

---

## 2026-02-22

### ユーザー用アプリ — バッジ一覧画面の取得済み/未取得表示分岐

**取得済みバッジの表示**
- [ ] バッジ一覧画面を開き、取得済みバッジにバッジ画像とバッジ名が正しく表示されること
- [ ] 取得済みバッジのカード背景が白、アイコン背景がオレンジ系であること
- [ ] 取得済みバッジをタップ → 詳細ダイアログにバッジ画像・バッジ名・カテゴリ・説明文が正しく表示されること

**未取得バッジの表示**
- [ ] 未取得バッジのカードに「？」アイコンが表示され、バッジ画像が表示されないこと
- [ ] 未取得バッジの名前が「？？？」と表示されること
- [ ] 未取得バッジのカード背景がグレー系、アイコン背景がグレー系であること
- [ ] 未取得バッジをタップ → 詳細ダイアログに「？」アイコン・「？？？」名前・「条件を達成してバッジを獲得しよう！」メッセージが表示されること
- [ ] 未取得バッジの詳細ダイアログにバッジ画像や実際の説明文が表示されないこと

**フィルター機能**
- [ ] ヘッダー右上のフィルターボタンをタップ → 全カテゴリ（取得済み/未取得問わず）がフィルターダイアログに表示されること
- [ ] カテゴリを選択 → 該当カテゴリのバッジのみ表示されること（取得済み/未取得の表示は維持）
- [ ] 「すべて」を選択 → 全バッジが表示されること

**データ取得**
- [ ] バッジ一覧画面を開いた際にローディングインジケーターが表示され、読み込み完了後にバッジグリッドに切り替わること
- [ ] Firestore取得エラー時に「バッジの読み込みに失敗しました」メッセージが表示され、クラッシュしないこと

**境界値・異常系**
- [ ] バッジを1つも取得していないユーザーで画面を開く → 全バッジが「？」アイコン・「？？？」で表示されること
- [ ] 全141個のバッジを取得済みのユーザーで画面を開く → 全バッジに画像と名前が表示されること
- [ ] 未ログイン状態でバッジ一覧画面を開く → 「ログインが必要です」画面が表示されること
- [ ] ネットワーク切断状態でバッジ一覧画面を開く → エラー表示が出てクラッシュしないこと

### 店舗用アプリ — 統計UIの共通ウィジェット化（StatsCard）

**ホーム画面「今日の統計」**
- [ ] ホーム画面を開き「今日の統計」カードが表示されること
- [ ] 「今日の来店者」「今日の新規顧客」「今日のクーポン使用」の3項目が横並びで表示され、値が正しいこと
- [ ] 各項目間に縦区切り線が表示されていること
- [ ] データ読み込み中に「...」が表示され、読み込み完了後に数値に切り替わること
- [ ] 統計取得に失敗した場合「統計情報の取得に失敗しました」エラーが表示されること

**分析画面「月間来店者数」**
- [ ] 分析画面を開き「月間来店者数」カードが表示されること（カレンダーアイコン付き）
- [ ] 「月間来店者数」「月間新規顧客数」「月間クーポン使用者数」の3項目が横並びで表示され、値が正しいこと
- [ ] 各項目間に縦区切り線が表示されていること
- [ ] 店舗IDがnullの場合（未登録）、プレースホルダーが表示されること

**データ画面「統計情報」**
- [ ] 各データ詳細画面（店舗利用者推移・新規顧客推移・クーポン使用推移など）を開き「統計情報」カードが表示されること（分析アイコン付き）
- [ ] 合計・最大・最小・平均の4項目が横並びで正しい値を表示していること
- [ ] データが0件の場合、空データメッセージが表示されること
- [ ] チャート上部のインライン統計（primaryChartStats/secondaryChartStats設定画面）が正常に表示されること

**共通**
- [ ] 全統計カードの高さが以前より低くなり、コンパクトに表示されていること
- [ ] 各カードの背景色（白）・角丸（16px）・影が統一されていること（ホーム画面のみ影なし）
- [ ] iPhone SE（小画面）で項目が重なったり、テキストが切れたりしないこと
- [ ] iPad（大画面）でレイアウトが崩れないこと

### 店舗用アプリ — 分析画面「全来店記録」円グラフ開始位置変更

- [ ] 分析画面を開き「全来店記録」セクションの男女比円グラフが12時の位置（真上）から時計回りに描画されていること
- [ ] 年齢別円グラフが12時の位置から時計回りに描画されていること
- [ ] 新規/リピート円グラフが12時の位置から時計回りに描画されていること
- [ ] 各円グラフのパーセンテージ表示が正しく、凡例の数値と一致していること
- [ ] データが1件のみの場合、円グラフが12時の位置から開始されていること
- [ ] データが0件（全来店記録なし）の場合、「データがありません」と表示されること

### ユーザー用アプリ — バッジ取得ポップアップ重複表示防止

**セッション内重複表示防止**
- [ ] 新しいバッジを取得した状態でホーム画面を開く → バッジ取得ポップアップが1回表示されること
- [ ] ポップアップを閉じた後、別タブに移動してホームタブに戻る → 同じバッジのポップアップが再表示されないこと
- [ ] 上記操作を複数回繰り返しても再表示されないこと
- [ ] 複数のバッジを同時に取得した場合、全てのバッジが順番に表示され、再度ホームに戻っても再表示されないこと

**ローカル定義バッジのみ表示**
- [ ] バッジ取得ポップアップに表示されるバッジが、ローカル定義（kBadgeDefinitions）に存在するバッジのみであること
- [ ] ポップアップに表示されるバッジの名前・説明・画像がローカル定義の最新情報と一致していること
- [ ] バッジ画像がローカルアセット（assets/images/badges/）から正しく読み込まれていること
- [ ] ネットワーク画像URL（旧バッジ形式）のバッジがポップアップに混在しないこと

**旧バッジの自動クリーンアップ**
- [ ] 旧バッジ（ローカル定義に存在しないバッジ）が `user_badges` に `isNew: true` で存在する場合、ホーム画面表示後に `isNew: false` に自動更新されること
- [ ] 上記クリーンアップ後、再度ホームに戻っても旧バッジのポップアップが表示されないこと

**本日初ログイン時のフロー**
- [ ] 本日初ログイン時にレコメンドポップアップが表示された後、バッジポップアップが正常に表示されること
- [ ] レコメンドポップアップ→バッジポップアップの順序が正しいこと

**異常系**
- [ ] バッジが0件（新規バッジなし）の状態でホーム画面を開く → ポップアップが表示されないこと
- [ ] ネットワークエラー発生時にクラッシュせず、ポップアップが表示されないこと

### ユーザー用アプリ — 新規登録ミッション未完了時のデイリーミッション・ログインストリーク停止

**新規登録ミッション未完了ユーザー（デイリーミッション達成処理の停止）**
- [ ] 新規登録ミッションを1つも完了していないユーザーでログイン → ホーム画面のミッションフローティングボタンがグレーアウト（青く光らない）であること
- [ ] 同状態でアプリを開いても、`daily_missions` サブコレクションに `app_open: true` が書き込まれないこと
- [ ] 同状態でデイリーレコメンド画面を表示しても、`recommendation_view: true` が書き込まれないこと
- [ ] 同状態で投稿詳細画面を表示しても、`feed_view: true` が書き込まれないこと
- [ ] 同状態でログインストリーク（`loginStreak`）が更新されないこと

**新規登録ミッション一部完了ユーザー**
- [ ] 新規登録ミッション5つのうち4つを受取済み・1つ未受取のユーザーでアプリを開く → ミッションボタンが青く光ること（未受取の新規登録ミッションがあるため）
- [ ] 同状態でデイリーミッションの達成処理（`app_open`等）が走っていないこと（Firestoreに記録されないこと）

**新規登録ミッション全完了後のデイリーミッション解放**
- [ ] 新規登録ミッション5つすべてを受取完了した状態でアプリを再起動 → デイリーミッション「アプリを開く」が達成されること（`app_open: true` が書き込まれること）
- [ ] 同状態でデイリーレコメンド画面を表示 → 「レコメンドを見る」が達成されること
- [ ] 同状態で投稿詳細画面を表示 → 「投稿を1件見る」が達成されること
- [ ] 同状態でログインストリーク（`loginStreak`）が正常に更新されること
- [ ] デイリーミッション達成後にミッションボタンが青く光ること

**ミッション画面のタブ制御との整合性**
- [ ] 新規登録ミッション未完了時、ミッション画面を開く → 「デイリー」「ログイン」タブがグレーアウトでタップ不可であること
- [ ] 新規登録ミッション未完了時、「新規登録」タブが自動選択されていること
- [ ] 新規登録ミッション全完了後、ミッション画面を開く → 全タブがタップ可能であること
- [ ] 新規登録ミッション全完了後、「デイリー」タブに達成状況が正しく表示されていること

**異常系**
- [ ] 新規登録ミッション完了チェック中にネットワークエラーが発生した場合、デイリーミッション処理が実行されないこと（安全側に倒れること）
- [ ] ゲストモード（未ログイン）でミッションフローティングボタンが表示されないこと（既存動作維持）

### ユーザー用アプリ — デイリーレコメンドのスコアリングアルゴリズム（ドキュメント整合性確認）

**レコメンド店舗の表示**
- [ ] 本日初回ログイン時にデイリーレコメンド画面が自動表示され、最大3件の店舗カードが表示されること
- [ ] isActive=false または isApproved=false の店舗がレコメンドに表示されないこと
- [ ] 各店舗カードに店舗画像・アイコン・店舗名・営業時間・説明が正しく表示されていること

**スコアリングの動作確認**
- [ ] お気に入り店舗と同じカテゴリの店舗が優先的にレコメンドされること（カテゴリ一致+2）
- [ ] ユーザープロフィールの都道府県・市区町村と店舗住所が一致する店舗が優先されること（エリア一致+1）
- [ ] 未訪問（スタンプ未獲得）の店舗が優先的にレコメンドされること（未訪問+2）
- [ ] 訪問済み（スタンプ獲得済み）の店舗もレコメンドに表示される場合があること（訪問済み−1、ただし除外はされない）
- [ ] 現在地から1km以内の店舗が最も優先的にレコメンドされること（+3）
- [ ] 位置情報を許可しない場合でも、カテゴリ・エリア・訪問状況ベースでレコメンドが表示されること

**レコメンド理由タグ**
- [ ] 近距離の店舗に「近く」（1km以内）または「近距離」（3km以内）タグが表示されること
- [ ] カテゴリ一致の店舗に「好み」タグが表示されること
- [ ] 未訪問の店舗に「未訪問」タグが表示されること
- [ ] エリア一致の店舗に「エリア」タグが表示されること

**インプレッション・クリック記録**
- [ ] レコメンド画面表示時にFirestoreの `recommendation_impressions` コレクションに表示記録が作成されること
- [ ] 店舗カードの「詳細を見る」タップ時に `recommendation_clicks` コレクションにクリック記録が作成されること

**異常系・境界値**
- [ ] storesコレクションに店舗が0件の場合「おすすめ店舗が見つかりませんでした」と表示されること
- [ ] 候補店舗が3件未満の場合、表示可能な件数分だけ表示されること
- [ ] ネットワークエラー時に「おすすめ店舗の取得に失敗しました」と表示され、クラッシュしないこと
- [ ] ゲストモード（未ログイン）でもレコメンド画面が表示できること（訪問状況・カテゴリ情報なしでの表示）

### ユーザー用・店舗用アプリ共通 — お知らせ・通知画面の統合リスト化

**お知らせ一覧画面（NotificationsView）**
- [ ] お知らせ画面を開き、タブ（「お知らせ」「通知」）が表示されず、単一のリストが表示されること
- [ ] リスト内にお知らせ（運営配信）と通知（個人向け）が混在して日時の新しい順に表示されていること
- [ ] 各アイテムがシンプルなListTile形式で表示されていること（Card/バッジなし）
- [ ] 未読アイテムに赤い丸インジケーター・薄い青背景・太字タイトルが適用されていること
- [ ] 既読アイテムは通常背景・通常フォントで表示されていること
- [ ] 各アイテムに本文（1行）と相対日時（「X日前」「X時間前」等）が表示されていること
- [ ] お知らせアイテムをタップ → お知らせ詳細画面（AnnouncementDetailView）に遷移すること
- [ ] 通知アイテムをタップ → 通知詳細画面（NotificationDetailView）に遷移すること
- [ ] お知らせ・通知がどちらも0件の場合、「お知らせはありません」の空状態メッセージが表示されること
- [ ] お知らせのみ存在・通知のみ存在の場合でも、正常にリスト表示されること
- [ ] ネットワークエラー時にエラー表示と再試行ボタンが表示されること

**通知詳細画面（NotificationDetailView）— タグChip削除**
- [ ] 通知詳細画面を開き、本文の下にタグChip（`live_chat` 等の四角形ラベル）が表示されないこと
- [ ] 種別バッジ、日時、タイトル、本文は引き続き正常に表示されていること
- [ ] 画像付き通知の場合、画像が正常に表示されていること
- [ ] 通知詳細画面を開いた際に自動既読化が正常に動作すること

**お知らせ詳細画面（AnnouncementDetailView）**
- [ ] お知らせ詳細画面を開き、カテゴリ・優先度バッジが上部に正常に表示されていること
- [ ] タイトル、公開日時、本文が正常に表示されていること
- [ ] お知らせ詳細画面を開いた際に自動既読化が正常に動作すること
- [ ] 既読後に一覧に戻ると、該当アイテムが既読表示に切り替わること

### ユーザー用アプリ — ホーム画面バッジカウントのローカル定義フィルタリング

**バッジカウントの正確性**
- [ ] ホーム画面の統計カプセルバーに表示されるバッジ数が、バッジ一覧画面で取得済み（カラー表示）のバッジ数と一致すること
- [ ] バッジ一覧画面で「すべて」カテゴリを選択し、取得済みバッジの数を数える → ホーム画面のバッジ数と同一であること
- [ ] 新しいバッジを獲得した後、ホーム画面に戻る → バッジカウントが+1されること

**ローカル定義フィルタリング**
- [ ] Firestoreの `user_badges/{userId}/badges` にローカル定義（kBadgeDefinitions）に存在しないバッジドキュメントがある場合、そのバッジがホーム画面のカウントに含まれないこと
- [ ] ローカル定義に存在するバッジのみがカウントされ、旧バッジ（廃止済み）がカウントに加算されないこと

**リアルタイム更新**
- [ ] バッジ獲得後にホーム画面に戻ると、カウントがリアルタイムで更新されること（プルリフレッシュ不要）
- [ ] プルリフレッシュ操作を行った際にバッジカウントが正しく再取得されること

**異常系・境界値**
- [ ] バッジを1つも取得していないユーザーのホーム画面でバッジ数が「0」と表示されること
- [ ] 全141個のバッジを取得済みのユーザーのホーム画面でバッジ数が「141」と表示されること
- [ ] 未ログイン状態でホーム画面のバッジ数が「-」と表示されること
- [ ] Firestore接続エラー時にバッジ数が「-」と表示され、クラッシュしないこと

### Firestoreルール — feedbackコレクションのルール追加

**フィードバック送信（ユーザー用・店舗用アプリ共通）**
- [ ] ログイン済みユーザーでフィードバック送信画面を開き、必須項目を入力して送信 → エラーなく送信が完了すること
- [ ] 送信後にFirestoreの `feedback` コレクションにドキュメントが作成されていること
- [ ] 未ログイン状態でフィードバック送信を試みた場合、エラーまたは認証要求が表示されること

**フィードバック管理（店舗用アプリ — 管理者オーナー）**
- [ ] 管理者オーナーでログインし、設定画面 → フィードバック管理を開く → フィードバック一覧が正常に表示されること
- [ ] フィードバック詳細画面でステータスを「pending」→「reviewed」に変更 → 正常に更新されること
- [ ] フィードバック詳細画面でステータスを「reviewed」→「resolved」に変更 → 正常に更新されること

**フィードバック管理（権限テスト）**
- [ ] 一般店舗ユーザー（isOwner=false）でフィードバック一覧を表示 → 読み取りは可能であること
- [ ] 一般店舗ユーザーでフィードバックのステータスを更新しようとする → 権限エラーで拒否されること
- [ ] フィードバックの削除操作を試みる → 権限エラーで拒否されること（全ユーザー共通で削除禁止）

### 店舗用アプリ — フィードバック管理の通知バッジ表示

**バッジ表示（設定画面）**
- [ ] 未確認（pending）フィードバックが1件以上ある状態で設定画面を開く → 「フィードバック管理」メニューの右側に赤い数字バッジが表示されること
- [ ] バッジの数字がFirestoreの `feedback` コレクションで `status == 'pending'` のドキュメント数と一致すること
- [ ] 未確認フィードバックが100件以上の場合、バッジに「99+」と表示されること
- [ ] 未確認フィードバックが0件の場合、バッジが表示されないこと

**バッジのリアルタイム更新**
- [ ] フィードバック管理画面でステータスを「pending」→「reviewed」に変更後、設定画面に戻る → バッジの数字が1減っていること
- [ ] 新しいフィードバックが送信された場合、設定画面のバッジ数字がリアルタイムで増加すること

**設定タブの合計バッジ**
- [ ] 未確認フィードバックがある状態で、ボトムナビゲーションの設定タブアイコンにバッジが反映されていること（他のバッジカウントとの合計）
- [ ] フィードバックバッジ以外のバッジ（ライブチャット・未承認店舗・削除申請）も正常に表示されていること

**異常系**
- [ ] Firestoreへの接続エラー時にバッジが「0」として表示され、クラッシュしないこと
- [ ] 管理者オーナー以外のユーザーでログイン → 「オーナー管理」セクション自体が表示されず、フィードバックバッジも表示されないこと

